version: "3.8"

services:
  web:
    build: .
    #command: daphne -b 0.0.0.0 -p 8000 naklario.asgi:application
    command: pipenv run python manage.py runserver 0.0.0.0:8000
    working_dir: /code/naklar-io
    ports:
      - 8000:8000
    volumes:
      - type: bind
        source: ./naklar-io
        target: /code/naklar-io
      - type: bind
        source: ./media
        target: /opt/media
      - type: volume
        source: static
        target: /opt/static
    restart: always

  #smtpd:
  #  image: python:3.7
  #  command: python3 -u -m smtpd -n -c DebuggingServer 0.0.0.0:1025

  celery_worker:
    build: .
    working_dir: /code/naklar-io
    command: pipenv run celery -A naklario worker -l info
    volumes:
      - type: bind
        source: ./naklar-io
        target: /code/naklar-io
    depends_on:
      - rabbitmq
      - web

  celery_beat:
    build: .
    working_dir: /code/naklar-io
    command: pipenv run celery -A naklario beat -S django -l info
    volumes:
      - type: bind
        source: ./naklar-io
        target: /code/naklar-io
    depends_on:
      - rabbitmq
      - web

  rabbitmq:
    image: rabbitmq

  nginx:
    image: nginx:stable
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - type: bind
        source: ./media
        target: /opt/media
      - type: volume
        source: static
        target: /opt/static
        volume:
          nocopy: true
    ports:
      - 8080:80

  # mysql:
  #   image: mariadb
  #   environment:
  #     MYSQL_ROOT_PASSWORD: "docker"
  #     MYSQL_DATABASE: "docker"
  #     MYSQL_USER: "docker"
  #     MYSQL_PASSWORD: "docker"

  #   ports:
  #     - 3306:3306
  #   volumes:
  #     - type: volume
  #       source: database
  #       target: /var/lib/mysql

volumes:
  static:
  database:
